<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GSC Response Form</title>
  <style>
    /* [styles unchanged for brevity, already correct from your code] */
  </style>
</head>
<body>
  <div class="form-container">
    <h2>GSC Response Form</h2>
    <form id="gsc-form">
      <div class="name-fields">
        <input id="firstname" type="text" placeholder="First Name" required />
        <input id="lastname" type="text" placeholder="Last Name" required />
      </div>

      <div style="display: flex; justify-content: space-between; align-items: center;">
        <label for="question-display"><strong>Question</strong></label>
        <a href="https://view.officeapps.live.com/op/view.aspx?src=https%3A%2F%2Fraw.githubusercontent.com%2Falexsamuel1790%2Fgsc%2Frefs%2Fheads%2Fmain%2FCore%2520KPI%2520Operational%2520Definitions%2520%2526%2520Targets_EJM.docx" target="_blank">
          <img src="https://img.icons8.com/color/32/000000/microsoft-word-2019--v1.png" />
        </a>
      </div>

      <textarea id="question-display" class="question-textarea" readonly>
Dear Applicant:

Please read the instructions below and complete the 4-part assignment:

PART I - Enclosed you will find a Study Summary describing a fictional clinical trial investigating the efficacy and safety of an antidepressant drug, genoxyl, in a geriatric population. Your target reader needs a concise overview of the study.

Write a structured abstract (Objectives, Methods, Results, and Conclusion) based on the Study Summary. Your abstract should be structured with appropriate subheadings, should use complete sentences (not phrases as some journals allow), and should be approximately 300 words. List the word count at the end of your abstract.
      </textarea>

      <div class="answer-label-row">
        <label for="question1"><strong>Your Answer</strong></label>
        <div class="table-controls">
          <input id="rows" type="number" min="0" placeholder="Rows" />
          <input id="cols" type="number" min="0" placeholder="Cols" />
          <button type="button" onclick="insertOrExpandTable()">➕ Table</button>
          <button type="button" onclick="removeLastRow()">➖ Row</button>
          <button type="button" onclick="removeLastColumn()">➖ Col</button>
        </div>
      </div>

      <div id="question1" class="answer-textarea" contenteditable="true"></div>

      <div class="button-group">
        <button type="button" id="save-btn">Save</button>
        <button type="submit">Submit</button>
      </div>

      <div id="saved-message"></div>
    </form>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://tubykfllyifovgqczodp.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    );

    const form = document.getElementById("gsc-form");

    function extractTableJSON() {
      const table = document.querySelector("#question1 table#answer-table");
      if (!table) return null;

      const tableData = [];
      for (let row of table.rows) {
        const rowData = [];
        for (let cell of row.cells) {
          rowData.push(cell.innerText.trim());
        }
        tableData.push(rowData);
      }

      return { table: tableData };
    }

    document.getElementById("save-btn").addEventListener("click", () => {
      const firstname = document.getElementById("firstname").value;
      const lastname = document.getElementById("lastname").value;
      const answerHTML = document.getElementById("question1").innerHTML;

      localStorage.setItem("firstname", firstname);
      localStorage.setItem("lastname", lastname);
      localStorage.setItem("question1", answerHTML);

      const savedTime = new Date().toLocaleString();
      localStorage.setItem("savedTime", savedTime);
      document.getElementById("saved-message").textContent = "Draft last saved on: " + savedTime;
    });

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("firstname").value = localStorage.getItem("firstname") || "";
      document.getElementById("lastname").value = localStorage.getItem("lastname") || "";
      document.getElementById("question1").innerHTML = localStorage.getItem("question1") || "";
      const savedTime = localStorage.getItem("savedTime");
      if (savedTime) {
        document.getElementById("saved-message").textContent = "Draft last saved on: " + savedTime;
      }
    });

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const firstname = document.getElementById("firstname").value.trim();
      const lastname = document.getElementById("lastname").value.trim();
      const question1 = document.getElementById("question1").innerHTML.trim();
      const answer1tb = extractTableJSON();

      const { error } = await supabase.from("gsc_response").insert([{ firstname, lastname, question1, answer1tb }]);

      if (error) {
        alert("Submission failed: " + error.message);
      } else {
        alert("Response submitted successfully!");
        form.reset();
        document.getElementById("question1").innerHTML = "";
        localStorage.clear();
        document.getElementById("saved-message").textContent = "";
      }
    });

    window.insertOrExpandTable = function () {
      const rows = parseInt(document.getElementById("rows").value || "0", 10);
      const cols = parseInt(document.getElementById("cols").value || "0", 10);
      if ((isNaN(rows) || rows < 0) || (isNaN(cols) || cols < 0) || (rows === 0 && cols === 0)) {
        alert("Please enter at least one positive value for rows or columns.");
        return;
      }

      const editor = document.getElementById("question1");
      let table = editor.querySelector("table#answer-table");

      if (!table) {
        table = document.createElement("table");
        table.id = "answer-table";
        table.style.borderCollapse = "collapse";
        table.style.marginTop = "10px";
        table.style.width = "100%";
        for (let i = 0; i < rows; i++) {
          const tr = document.createElement("tr");
          for (let j = 0; j < cols; j++) {
            const td = document.createElement("td");
            td.contentEditable = "true";
            td.style.cssText = `border: 1px solid #999; font-size: 16px; font-family: 'Segoe UI', sans-serif; line-height: 1.5; padding: 12px 6px;`;
            tr.appendChild(td);
          }
          table.appendChild(tr);
        }
        editor.appendChild(table);
      } else {
        const existingRows = table.rows.length;
        const existingCols = existingRows > 0 ? table.rows[0].cells.length : 0;

        if (rows > 0) {
          for (let i = 0; i < rows; i++) {
            const tr = document.createElement("tr");
            for (let j = 0; j < (cols > 0 ? cols : existingCols); j++) {
              const td = document.createElement("td");
              td.contentEditable = "true";
              td.style.cssText = `border: 1px solid #999; font-size: 16px; font-family: 'Segoe UI', sans-serif; line-height: 1.5; padding: 12px 6px;`;
              tr.appendChild(td);
            }
            table.appendChild(tr);
          }
        }

        if (cols > 0) {
          [...table.rows].forEach((row) => {
            const currentCols = row.cells.length;
            for (let j = currentCols; j < currentCols + cols; j++) {
              const td = document.createElement("td");
              td.contentEditable = "true";
              td.style.cssText = `border: 1px solid #999; font-size: 16px; font-family: 'Segoe UI', sans-serif; line-height: 1.5; padding: 12px 6px;`;
              row.appendChild(td);
            }
          });
        }
      }
    };

    window.removeLastRow = function () {
      const table = document.querySelector("#question1 table#answer-table");
      if (table && table.rows.length > 0) {
        table.deleteRow(table.rows.length - 1);
      }
    };

    window.removeLastColumn = function () {
      const table = document.querySelector("#question1 table#answer-table");
      if (table && table.rows.length > 0 && table.rows[0].cells.length > 0) {
        Array.from(table.rows).forEach(row => row.deleteCell(row.cells.length - 1));
      }
    };
  </script>
</body>
</html>
